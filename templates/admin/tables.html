{% extends "base.html" %}

{% block title %}Управление столиками - Ресторан "Гурман"{% endblock %}

{% block content %}
<div class="container">
    <h1 class="section-title">Управление столиками</h1>
    
    <!-- Статистика -->
    <div class="tables-stats-cards">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chair"></i>
            </div>
            <div class="stat-info">
                <span class="stat-label">Всего столиков</span>
                <span class="stat-value">{{ tables|length }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-user-friends"></i>
            </div>
            <div class="stat-info">
                <span class="stat-label">Всего мест</span>
                <span class="stat-value">{{ tables|sum(attribute='seats') }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-info">
                <span class="stat-label">Активные брони</span>
                <span class="stat-value">{{ reservations|selectattr('status', 'equalto', 'active')|list|length }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <span class="stat-label">Ожидают подтверждения</span>
                <span class="stat-value">{{ reservations|selectattr('status', 'equalto', 'pending')|list|length }}</span>
            </div>
        </div>
    </div>
    
    <div class="tables-management">
        <!-- Список столиков -->
        <div class="tables-list-section">
            <h2>Столики (10 шт по 4 места)</h2>
            <div class="tables-grid">
                {% for table in tables %}
                <div class="table-card {% if table.is_reserved %}reserved{% else %}available{% endif %}">
                    <div class="table-header">
                        <h3>Столик №{{ table.table_number }}</h3>
                        <span class="table-status">
                            {% if table.is_reserved %}
                            <span class="status status-reserved">Занят</span>
                            {% else %}
                            <span class="status status-available">Свободен</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="table-info">
                        <p><i class="fas fa-users"></i> Мест: {{ table.seats }}</p>
                        {% if table.is_reserved %}
                        <p class="reservation-info">
                            {% set table_reservation = reservations|selectattr('table_id', 'equalto', table.id)|first %}
                            {% if table_reservation %}
                            Бронь: {{ table_reservation.reservation_time.strftime('%d.%m.%Y %H:%M') }}<br>
                            Гостей: {{ table_reservation.guests_count }}
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                    <div class="table-actions">
                        {% if table.is_reserved %}
                        <button class="btn btn-small btn-outline" onclick="freeTable({{ table.id }})">
                            Освободить
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Список бронирований -->
        <div class="reservations-section">
            <h2>Бронирования</h2>
            <div class="reservations-list">
                {% for reservation in reservations %}
                <div class="reservation-card">
                    <div class="reservation-header">
                        <h4>Бронь #{{ reservation.id }}</h4>
                        <span class="reservation-status status-{{ reservation.status }}">
                            {{ reservation.status }}
                        </span>
                    </div>
                    <div class="reservation-info">
                        <p><i class="far fa-clock"></i> {{ reservation.reservation_time.strftime('%d.%m.%Y %H:%M') }}</p>
                        <p><i class="fas fa-users"></i> Гостей: {{ reservation.guests_count }}</p>
                        <p><i class="fas fa-user"></i> Клиент: {{ reservation.user.username }}</p>
                        {% if reservation.table %}
                        <p><i class="fas fa-chair"></i> Столик: №{{ reservation.table.table_number }}</p>
                        {% else %}
                        <p><i class="fas fa-question-circle"></i> Столик: Не назначен</p>
                        {% endif %}
                    </div>
                    <div class="reservation-actions">
                        {% if not reservation.table_id and reservation.status == 'pending' %}
                        <div class="table-assignment">
                            <select class="form-control form-control-sm" id="table-select-{{ reservation.id }}">
                                <option value="">Выберите столик</option>
                                {% for table in tables if not table.is_reserved and table.seats >= reservation.guests_count %}
                                <option value="{{ table.id }}">№{{ table.table_number }} ({{ table.seats }} мест)</option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-small btn-primary" onclick="assignTableToReservation({{ reservation.id }})">
                                Назначить
                            </button>
                        </div>
                        {% endif %}
                        <a href="{{ url_for('admin_order_details', order_id=reservation.order_id) }}" 
                           class="btn btn-small btn-outline">
                            К заказу
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
    .tables-stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        background-color: var(--primary-color);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }
    
    .stat-info {
        display: flex;
        flex-direction: column;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: var(--gray);
        margin-bottom: 5px;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    .tables-management {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }
    
    .tables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .table-card {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        border-left: 5px solid var(--success);
    }
    
    .table-card.reserved {
        border-left-color: var(--danger);
        opacity: 0.8;
    }
    
    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .table-header h3 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--heading-color);
    }
    
    .table-status .status {
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .status-available {
        background-color: var(--success);
        color: white;
    }
    
    .status-reserved {
        background-color: var(--danger);
        color: white;
    }
    
    .table-info {
        margin-bottom: 15px;
    }
    
    .table-info p {
        margin: 5px 0;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .reservation-info {
        font-size: 0.8rem !important;
        color: var(--gray);
        margin-top: 10px !important;
        padding-top: 10px;
        border-top: 1px solid var(--gray-light);
    }
    
    .table-actions {
        display: flex;
        gap: 10px;
    }
    
    .reservations-list {
        display: grid;
        gap: 15px;
        margin-top: 15px;
    }
    
    .reservation-card {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        border-left: 5px solid var(--primary-color);
    }
    
    .reservation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .reservation-header h4 {
        margin: 0;
        color: var(--heading-color);
    }
    
    .reservation-status {
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: capitalize;
    }
    
    .status-pending {
        background-color: var(--warning);
        color: white;
    }
    
    .status-active {
        background-color: var(--success);
        color: white;
    }
    
    .status-cancelled {
        background-color: var(--danger);
        color: white;
    }
    
    .reservation-info p {
        margin: 5px 0;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .reservation-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }
    
    .table-assignment {
        display: flex;
        gap: 10px;
        width: 100%;
    }
    
    .table-assignment select {
        flex: 1;
    }
    
    .btn-small {
        padding: 5px 10px;
        font-size: 0.9rem;
    }
    
    @media (max-width: 992px) {
        .tables-management {
            grid-template-columns: 1fr;
        }
        
        .tables-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
    }
    
    @media (max-width: 768px) {
        .tables-stats-cards {
            grid-template-columns: 1fr 1fr;
        }
        
        .table-assignment {
            flex-direction: column;
        }
    }
</style>

<script>
    // Освобождение столика
    async function freeTable(tableId) {
        if (!confirm('Вы уверены, что хотите освободить этот столик?')) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/table/${tableId}/free`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showNotification('Столик успешно освобожден', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showNotification(data.error || 'Ошибка освобождения столика', 'error');
            }
        } catch (error) {
            showNotification('Ошибка сети', 'error');
        }
    }
    
    // Назначение столика для бронирования
    async function assignTableToReservation(reservationId) {
        const tableSelect = document.getElementById(`table-select-${reservationId}`);
        const tableId = tableSelect.value;
        
        if (!tableId) {
            showNotification('Выберите столик', 'error');
            return;
        }
        
        try {
            const response = await fetch(`/admin/reservation/${reservationId}/assign_table`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ table_id: tableId })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showNotification('Столик успешно назначен', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showNotification(data.error || 'Ошибка назначения столика', 'error');
            }
        } catch (error) {
            showNotification('Ошибка сети', 'error');
        }
    }
    
    // Автоматическое обновление статуса столиков каждые 10 секунд
    document.addEventListener('DOMContentLoaded', function() {
        setInterval(() => {
            // Здесь можно добавить автоматическое обновление
            // или оставить как есть для ручного обновления
        }, 10000);
    });
</script>
{% endblock %}
